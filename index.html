<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Shiruffs Adventure - Menú Principal y Tienda</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #1a1a1a; /* Un fondo oscuro limpio */
            display: flex;
            flex-direction: column; /* Apila los elementos verticalmente */
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden; /* Evita barras de desplazamiento */
            user-select: none; /* Previene la selección de texto */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            position: relative; /* Necesario para los elementos posicionados absolutamente */
            font-family: 'Press Start 2P', cursive; /* Fuente pixel art por defecto */
            color: #eceff1;
            text-shadow: 1px 1px 0px rgba(0, 0, 0, 0.7);
        }

        /* Estilos para ocultar/mostrar las secciones */
        .hidden {
            display: none !important;
        }

        /* Título del juego */
        .game-title {
            position: absolute;
            top: 30px; /* Ajustado para mover el título más arriba y centrarlo mejor */
            left: 50%; /* Centra horizontalmente el elemento */
            transform: translateX(-50%); /* Ajusta la posición para centrado perfecto */
            white-space: nowrap; /* Evita que el texto se rompa en varias líneas */
            font-family: 'Press Start 2P', cursive;
            font-size: 2.5em; /* Tamaño grande para el título */
            color: #FF8C00; /* Color naranja vibrante "a lo Dan the Man" */
            /* Sombra más pronunciada y pixelada */
            text-shadow: 6px 6px 0px #8B4513, /* Sombra principal más oscura y nítida */
                         10px 10px 0px rgba(0, 0, 0, 0.5); /* Sombra de profundidad más suave */
            z-index: 15; /* Asegura que esté por encima de todo */
        }

        /* Contenedor para los personajes principales */
        .character-row-container {
            position: absolute;
            top: 100px; /* Ajusta la altura de los personajes desde arriba, movido más abajo para el título */
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px; /* Espacio entre los personajes, ajustado para el nuevo diseño */
            align-items: flex-end; /* Alinea los personajes por la base */
            justify-content: center;
            z-index: 8; /* Asegura que estén detrás de los botones de la esquina si se superponen */
        }

        .character-icon {
            height: auto; /* Altura automática para mantener proporción */
            object-fit: contain; /* Asegura que la imagen se ajuste */
            image-rendering: pixelated; /* Mantiene el estilo pixel art */
            pointer-events: none; /* No son interactivos, son decorativos */
        }

        .main-character-icon {
            width: 350px; /* Tamaño muy grande para el personaje central */
        }

        .skeleton-icon {
            width: 200px; /* Tamaño para los esqueletos, más pequeños que el central */
        }

        /* Contenedor principal para centrar el grupo de botones */
        .game-menu {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px; /* Espacio entre el botón JUGAR y el grupo de abajo */
            padding: 20px;
            z-index: 10; /* AHORA EL MENÚ DE JUEGO ESTÁ ENCIMA DE LOS PERSONAJES */
            position: relative; /* Necesario para que z-index funcione correctamente */
            margin-top: 170px; /* MOVido aún más abajo */
        }

        /* Estilos generales para el botón estilo pixel art (JUGAR, Historia, Batalla, Multijugador) */
        .pixel-button {
            appearance: none; /* Restablece estilos por defecto del navegador */
            -webkit-appearance: none;
            -moz-appearance: none;
            background: none;
            border: none;
            padding: 15px 35px; /* Espaciado interno estándar aumentado */
            cursor: pointer;
            text-align: center;
            box-sizing: border-box;

            font-family: 'Press Start 2P', cursive;
            font-size: 1.2em; /* Fuente ligeramente más grande */
            color: #eceff1;
            text-shadow: 2px 2px 0px rgba(0, 0, 0, 0.7);
            text-transform: uppercase;

            background-color: #3f3f3f;
            border: 2px solid #8B4513;
            border-radius: 6px; /* Aseguramos un valor sensato */
            box-shadow:
                inset  0px 2px 0px 0px rgba(255, 255, 255, 0.15),
                0px 4px 0px 0px #5A2D0D,
                0px 6px 0px 0px #3F1D08;
            transition: all 0.1s ease-out;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            min-width: 220px; /* Ancho mínimo para consistencia, aumentado */
        }

        .pixel-button:hover {
            transform: translateY(-2px);
            box-shadow:
                inset 0px 2px 0px 0px rgba(255, 255, 255, 0.25),
                0px 6px 0px 0px #5A2D0D,
                0px 8px 0px 0px #3F1D08;
        }

        .pixel-button:active {
            transform: translateY(2px);
            box-shadow:
                inset 0px 1px 0px 0px rgba(255, 255, 255, 0.1),
                0px 2px 0px 0px #5A2D0D,
                0px 3px 0px 0px #3F1D08;
        }

        .pixel-button:focus {
            outline: none;
        }

        /* Estilos para el botón "JUGAR" (más grande) */
        #playButton {
            padding: 20px 40px; /* Más padding para hacerlo más grande */
            font-size: 1.5em; /* Fuente un poco más grande */
            min-width: 250px; /* Asegura un tamaño consistente */
        }

        /* Contenedor para los botones "Historia", "Batalla", "Multijugador" (en fila) */
        /* Eliminado para la estructura del menú principal */
        /*
        .primary-buttons-group {
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;
            gap: 20px;
            width: 100%;
            max-width: 650px;
        }

        .primary-buttons-group .pixel-button {
            flex-grow: 1;
            max-width: 220px;
        }
        */

        /* Estilos para el botón de texto "TIENDA" */
        #tiendaButton {
            position: absolute; /* Posicionamiento absoluto respecto al body */
            background: none; /* Sin fondo */
            border: none; /* Sin borde */
            cursor: pointer;
            font-family: 'Press Start 2P', cursive; /* Fuente Pixel Art para Tienda */
            font-size: 1.0em; /* Fuente más grande para Tienda */
            color: #eceff1;
            text-shadow: 1px 1px 0px rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            white-space: nowrap;
            transition: color 0.1s ease-out, transform 0.1s ease-out;
            z-index: 10;
            top: 250px; /* Posición del texto TIENDA */
            left: 20px; /* Posición horizontal ajustada */
            text-align: left;
        }

        #tiendaButton:hover {
            color: #FFD700;
        }

        #tiendaButton:active {
            transform: translateY(1px);
            color: #FFA500;
        }

        #tiendaButton:focus {
            outline: none;
        }

        /* Estilos para el nuevo botón "USERNAME" */
        #usernameButton {
            position: absolute;
            background: none;
            border: none;
            cursor: pointer;
            font-family: 'Press Start 2P', cursive;
            font-size: 1.0em;
            color: #eceff1;
            text-shadow: 1px 1px 0px rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            white-space: nowrap;
            transition: color 0.1s ease-out, transform 0.1s ease-out;
            z-index: 10;
            top: 250px; /* Mismo top que el botón de tienda */
            right: 20px; /* Posición horizontal ajustada a la derecha */
            text-align: right; /* Alineación a la derecha */
        }

        #usernameButton:hover {
            color: #FFD700;
        }

        #usernameButton:active {
            transform: translateY(1px);
            color: #FFA500;
        }

        #usernameButton:focus {
            outline: none;
        }

        /* Estilos para el botón de música */
        #musicToggleButton {
            position: absolute;
            background: none;
            border: none;
            cursor: pointer;
            font-family: 'Press Start 2P', cursive;
            font-size: 1.0em;
            color: #eceff1;
            text-shadow: 1px 1px 0px rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            white-space: nowrap;
            transition: color 0.1s ease-out, transform 0.1s ease-out;
            z-index: 10;
            bottom: 20px; /* Posición en la parte inferior */
            left: 20px;
            text-align: left;
        }

        #musicToggleButton:hover {
            color: #00BFFF; /* Color azul claro al pasar el ratón */
        }

        #musicToggleButton:active {
            transform: translateY(1px);
            color: #1E90FF; /* Color azul oscuro al hacer clic */
        }

        #musicToggleButton:focus {
            outline: none;
        }

        /* Estilos para la imagen de la tienda */
        .shop-icon {
            position: absolute;
            top: 130px; /* Posiciona el icono más arriba del texto TIENDA */
            left: 20px; /* Ajusta la posición horizontal */
            width: 150px; /* TAMAÑO GRANDE para el icono */
            height: auto;
            pointer-events: none; /* Asegura que no interfiera con los clics */
            z-index: 9; /* Por debajo de los botones de texto si se superponen */
        }
        /* Estilos para el icono de usuario */
        .user-icon-svg {
            position: absolute;
            top: 130px; /* Mismo top que el icono de la tienda */
            right: 20px; /* Posición horizontal ajustada a la derecha */
            width: 150px; /* Mismo tamaño que el icono de la tienda */
            height: auto;
            pointer-events: none;
            z-index: 9;
            image-rendering: pixelated; /* Asegura el renderizado pixelado del SVG */
        }

        /* Estilos para el nuevo botón de Logros (TEXTO con icono) */
        #logrosButton {
            position: absolute;
            background: none;
            border: none;
            cursor: pointer;
            font-family: 'Press Start 2P', cursive;
            font-size: 1.0em;
            color: #eceff1;
            text-shadow: 1px 1px 0px rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            white-space: nowrap;
            transition: color 0.1s ease-out, transform 0.1s ease-out;
            z-index: 10;
            top: 350px; /* Posición del texto LOGROS, más abajo de TIENDA (250px) */
            left: 20px; /* Misma posición horizontal que TIENDA */
            text-align: left;
            display: flex; /* Para alinear el icono y el texto */
            align-items: center; /* Centra verticalmente el icono y el texto */
        }

        #logrosButton:hover {
            color: #FFD700; /* Color al pasar el ratón, similar a TIENDA */
        }

        #logrosButton:active {
            transform: translateY(1px);
            color: #FFA500; /* Color al hacer clic, similar a TIENDA */
        }

        #logrosButton:focus {
            outline: none;
        }

        #logrosButton img {
            width: 40px; /* Tamaño del icono dentro del botón */
            height: 40px;
            margin-right: 10px; /* Espacio entre el icono y el texto */
            image-rendering: pixelated; /* Mantiene el estilo pixel art */
        }

        /* Estilos para el nuevo botón "Próximamente..." */
        #upcomingButton {
            position: absolute;
            background: none;
            border: none;
            cursor: pointer;
            font-family: 'Press Start 2P', cursive;
            font-size: 1.0em;
            color: #eceff1;
            text-shadow: 1px 1px 0px rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            white-space: nowrap;
            transition: color 0.1s ease-out, transform 0.1s ease-out;
            z-index: 10;
            top: 350px; /* Mismo top que Logros, pero a la derecha */
            right: 20px; /* Misma posición horizontal que USUARIO */
            text-align: right;
            display: flex; /* Para alinear el icono y el texto */
            align-items: center; /* Centra verticalmente el icono y el texto */
            flex-direction: row-reverse; /* Pone la imagen a la derecha del texto */
        }

        #upcomingButton:hover {
            color: #FFD700;
        }

        #upcomingButton:active {
            transform: translateY(1px);
            color: #FFA500;
        }

        #upcomingButton:focus {
            outline: none;
        }

        #upcomingButton img {
            width: 40px; /* Tamaño del icono */
            height: 40px;
            margin-left: 10px; /* Espacio entre el texto y el icono */
            margin-right: 0; /* Asegura que no haya margen derecho si se copia de otro lado */
            image-rendering: pixelated;
        }

        /* Estilos de la tienda */
        .shop-container {
            position: relative;
            width: 90%; /* Ancho responsivo */
            max-width: 800px; /* Ancho máximo para pantallas grandes */
            height: 70vh; /* Altura responsiva */
            max-height: 600px; /* Altura máxima */
            background-image: url('https://i.ibb.co/L5r03R2/shop-bg.png'); /* Fondo de tienda pixel art */
            background-size: cover;
            background-position: center;
            border: 5px solid #8B4513; /* Borde estilo pixel art */
            border-radius: 8px;
            box-shadow: 10px 10px 0px rgba(0, 0, 0, 0.5); /* Sombra para profundidad */
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .shop-header {
            font-size: 2em;
            margin-bottom: 20px;
            color: #FFD700; /* Color dorado para el título */
        }

        .items-grid {
            display: flex; /* Cambiado a flexbox */
            flex-direction: row; /* Elementos en fila */
            flex-wrap: wrap; /* Permite que los elementos se envuelvan a la siguiente línea si no caben */
            justify-content: center; /* Centra los elementos horizontalmente */
            gap: 20px;
            width: 100%;
            flex-grow: 1; /* Permite que la cuadrícula ocupe el espacio disponible */
            overflow-y: auto; /* Permite desplazamiento si hay muchos ítems */
            padding: 10px;
            box-sizing: border-box;
            background-color: rgba(0, 0, 0, 0.5); /* Fondo semitransparente para los ítems */
            border-radius: 5px;
        }

        .item-card {
            background-color: #3f3f3f;
            border: 2px solid #5A2D0D;
            border-radius: 4px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            text-align: center;
            box-shadow: 3px 3px 0px rgba(0, 0, 0, 0.5);
            min-width: 120px; /* Asegura un ancho mínimo para cada tarjeta de ítem */
            max-width: 150px; /* Ancho máximo para evitar que crezcan demasiado */
        }

        /* Estilos específicos para las imágenes dentro de las tarjetas de ítems */
        .item-card img {
            width: 60px; /* Tamaño por defecto del icono del ítem */
            height: 60px;
            object-fit: contain;
            image-rendering: pixelated; /* Mantiene el estilo pixel art */
        }

        /* Estilo para el icono de la guadaña, haciéndolo aún más grande para que se vea bien */
        .item-card img.scythe-icon {
            width: 120px; /* Un poco más grande para la guadaña */
            height: 120px; /* Mantiene la proporción */
        }

        .item-name {
            font-size: 0.8em;
            color: #fff;
        }

        .item-price {
            font-size: 0.9em;
            color: #90ee90; /* Verde claro para el precio */
        }

        /* Estilos para el botón de compra */
        .buy-button {
            appearance: none; -webkit-appearance: none; -moz-appearance: none;
            background: none; border: none;
            padding: 8px 15px;
            cursor: pointer; text-align: center; box-sizing: border-box;

            font-family: 'Press Start 2P', cursive;
            font-size: 0.7em;
            color: #eceff1;
            text-shadow: 1px 1px 0px rgba(0, 0, 0, 0.7);
            text-transform: uppercase;

            background-color: #4CAF50; /* Verde vibrante */
            border: 2px solid #2E8B57;
            border-radius: 4px;
            box-shadow:
                inset 0px 1px 0px 0px rgba(255, 255, 255, 0.2),
                0px 3px 0px 0px #1E8449; /* Sombra para profundidad */
            transition: all 0.1s ease-out;
            user-select: none;
            min-width: 80px;
        }

        .buy-button:hover {
            transform: translateY(-1px);
            box-shadow:
                inset 0px 1px 0px 0px rgba(255, 255, 255, 0.3),
                0px 4px 0px 0px #1E8449;
        }

        .buy-button:active {
            transform: translateY(1px);
            box-shadow:
                inset 0px 0px 0px 0px rgba(255, 255, 255, 0.1),
                0px 1px 0px 0px #1E8449;
        }

        .buy-button:focus {
            outline: none;
        }

        /* Botón de volver al menú */
        .back-button {
            margin-top: 20px;
            padding: 10px 20px;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.9em;
            color: #fff;
            background-color: #FF4500; /* Naranja rojizo */
            border: 2px solid #B22222;
            border-radius: 6px;
            cursor: pointer;
            box-shadow:
                inset 0px 2px 0px 0px rgba(255, 255, 255, 0.15),
                0px 4px 0px 0px #CD5C5C;
            transition: all 0.1s ease-out;
        }

        .back-button:hover {
            transform: translateY(-2px);
            box-shadow:
                inset 0px 2px 0px 0px rgba(255, 255, 255, 0.25),
                0px 6px 0px 0px #CD5C5C;
        }

        .back-button:active {
            transform: translateY(2px);
            box-shadow:
                inset 0px 1px 0px 0px rgba(255, 255, 255, 0.1),
                0px 1px 0px 0px #CD5C5C;
        }

        .back-button:focus {
            outline: none;
        }

        /* Estilos para el contenedor principal de autenticación */
        .auth-container {
            position: relative;
            width: 90%; /* Ancho responsivo */
            max-width: 400px; /* Ancho máximo para el formulario */
            background-color: #2a2a2a; /* Un fondo un poco más claro que el body */
            border: 5px solid #8B4513; /* Borde estilo pixel art */
            border-radius: 8px;
            box-shadow: 10px 10px 0px rgba(0, 0, 0, 0.5); /* Sombra para profundidad */
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            gap: 15px; /* Espacio entre los elementos del formulario */
        }

        .auth-container h2 {
            font-size: 1.5em;
            color: #FFD700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 0px rgba(0, 0, 0, 0.7);
        }

        /* Estilos para los inputs dentro de los formularios de autenticación */
        .auth-container input[type="email"],
        .auth-container input[type="password"],
        .auth-container input[type="text"] {
            width: calc(100% - 20px); /* Ancho del input con padding */
            padding: 10px;
            border: 2px solid #5A2D0D;
            background-color: #3f3f3f;
            color: #eceff1;
            font-family: 'Inter', sans-serif; /* Fuente más legible para inputs */
            font-size: 1em;
            border-radius: 4px;
            box-sizing: border-box;
            text-shadow: none; /* Elimina sombra de texto para inputs */
        }

        .auth-container input::placeholder {
            color: rgba(236, 239, 241, 0.5);
        }

        .auth-message {
            color: #FF4500; /* Color para mensajes de error */
            font-family: 'Inter', sans-serif;
            font-size: 0.9em;
            min-height: 1.5em; /* Espacio para el mensaje */
            text-align: center;
        }

        /* Estilos para los botones generales de autenticación */
        .auth-button {
            width: 100%;
            padding: 12px 20px;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.9em;
            color: #eceff1;
            text-shadow: 2px 2px 0px rgba(0, 0, 0, 0.7);
            text-transform: uppercase;
            background-color: #4CAF50; /* Verde vibrante */
            border: 2px solid #2E8B57;
            border-radius: 6px;
            box-shadow:
                inset 0px 2px 0px 0px rgba(255, 255, 255, 0.15),
                0px 4px 0px 0px #1E8449,
                0px 6px 0px 0px #0F4F2E;
            transition: all 0.1s ease-out;
            cursor: pointer;
        }

        .auth-button.google-button {
            background-color: #DD4B39; /* Rojo Google */
            border: 2px solid #A23223;
            box-shadow:
                inset 0px 2px 0px 0px rgba(255, 255, 255, 0.15),
                0px 4px 0px 0px #8B2C1F,
                0px 6px 0px 0px #6A1E14;
        }

        .auth-button:hover {
            transform: translateY(-2px);
            box-shadow:
                inset 0px 2px 0px 0px rgba(255, 255, 255, 0.25),
                0px 6px 0px 0px #1E8449,
                0px 8px 0px 0px #0F4F2E;
        }

        .auth-button.google-button:hover {
            box-shadow:
                inset 0px 2px 0px 0px rgba(255, 255, 255, 0.25),
                0px 6px 0px 0px #8B2C1F,
                0px 8px 0px 0px #6A1E14;
        }

        .auth-button:active {
            transform: translateY(2px);
            box-shadow:
                inset 0px 1px 0px 0px rgba(255, 255, 255, 0.1),
                0px 2px 0px 0px #1E8449,
                0px 3px 0px 0px #0F4F2E;
        }

        .auth-button.google-button:active {
            box-shadow:
                inset 0px 1px 0px 0px rgba(255, 255, 255, 0.1),
                0px 2px 0px 0px #8B2C1F,
                0px 3px 0px 0px #6A1E14;
        }

        .auth-button:focus {
            outline: none;
        }

        /* Alineación del botón de volver al menú de autenticación */
        #backToMenuAuthButton {
            margin-top: 20px;
        }

        /* Estilos específicos para los contenedores de elección y formularios */
        .auth-screen-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            gap: 15px;
        }

        /* Estilo para el mensaje de autoplay de música */
        #musicAutoPlayMessage {
            position: fixed;
            bottom: 60px; /* Ajusta la posición en relación al botón de música */
            left: 20px;
            background-color: rgba(255, 255, 0, 0.8);
            color: #333;
            padding: 8px 15px;
            border-radius: 5px;
            font-family: 'Inter', sans-serif;
            font-size: 0.8em;
            z-index: 100;
            animation: fadeOut 5s forwards; /* Animación para desvanecerse */
        }

        @keyframes fadeOut {
            0% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; display: none; }
        }

        /* Estilos para el contenedor principal del modo multijugador */
        .multiplayer-container, .selection-container { /* Añadido .selection-container */
            position: relative;
            width: 90%; /* Ancho responsivo */
            max-width: 800px; /* Ancho máximo para pantallas grandes */
            height: 70vh; /* Altura responsiva */
            max-height: 600px; /* Altura máxima */
            background-color: #2a2a2a; /* Un fondo oscuro consistente */
            border: 5px solid #8B4513; /* Borde estilo pixel art */
            border-radius: 8px;
            box-shadow: 10px 10px 0px rgba(0, 0, 0, 0.5); /* Sombra para profundidad */
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            font-family: 'Press Start 2P', cursive;
            color: #eceff1;
            text-shadow: 1px 1px 0px rgba(0, 0, 0, 0.7);
        }

        .multiplayer-header, .selection-header { /* Añadido .selection-header */
            font-size: 2em;
            margin-bottom: 20px;
            color: #FFD700; /* Color dorado para el título */
            text-align: center;
        }

        .multiplayer-section {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .multiplayer-input {
            width: calc(100% - 20px); /* Ancho del input con padding */
            padding: 10px;
            border: 2px solid #5A2D0D;
            background-color: #3f3f3f;
            color: #eceff1;
            font-family: 'Inter', sans-serif; /* Fuente más legible para inputs */
            font-size: 1em;
            border-radius: 4px;
            box-sizing: border-box;
            text-shadow: none;
            text-transform: uppercase; /* Para el código de sala */
            text-align: center;
        }

        .multiplayer-input::placeholder {
            color: rgba(236, 239, 241, 0.5);
        }

        .multiplayer-button {
            width: 100%;
            padding: 12px 20px;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.9em;
            color: #eceff1;
            text-shadow: 2px 2px 0px rgba(0, 0, 0, 0.7);
            text-transform: uppercase;
            background-color: #4CAF50; /* Verde vibrante */
            border: 2px solid #2E8B57;
            border-radius: 6px;
            box-shadow:
                inset 0px 2px 0px 0px rgba(255, 255, 255, 0.15),
                0px 4px 0px 0px #1E8449,
                0px 6px 0px 0px #0F4F2E;
            transition: all 0.1s ease-out;
            cursor: pointer;
        }

        .multiplayer-button:hover {
            transform: translateY(-2px);
            box-shadow:
                inset 0px 2px 0px 0px rgba(255, 255, 255, 0.25),
                0px 6px 0px 0px #1E8449,
                0px 8px 0px 0px #0F4F2E;
        }

        .multiplayer-button:active {
            transform: translateY(2px);
            box-shadow:
                inset 0px 1px 0px 0px rgba(255, 255, 255, 0.1),
                0px 2px 0px 0px #1E8449,
                0px 3px 0px 0px #0F4F2E;
        }

        .multiplayer-button.red-button {
            background-color: #FF4500; /* Naranja rojizo */
            border: 2px solid #B22222;
            box-shadow:
                inset 0px 2px 0px 0px rgba(255, 255, 0, 0.15),
                0px 4px 0px 0px #CD5C5C;
        }

        .multiplayer-button.red-button:hover {
            box-shadow:
                inset 0px 2px 0px 0px rgba(255, 255, 0, 0.25),
                0px 6px 0px 0px #CD5C5C;
        }

        .multiplayer-button.red-button:active {
            box-shadow:
                inset 0px 1px 0px 0px rgba(255, 255, 0, 0.1),
                0px 1px 0px 0px #CD5C5C;
        }


        .player-list {
            list-style: none;
            padding: 0;
            width: 100%;
            max-height: 150px;
            overflow-y: auto;
            border: 2px solid #5A2D0D;
            border-radius: 4px;
            background-color: rgba(0, 0, 0, 0.3);
        }

        .player-item {
            padding: 8px 10px;
            border-bottom: 1px solid #3f3f3f;
            display: flex;
            align-items: center;
            font-size: 0.9em;
        }

        .player-item:last-child {
            border-bottom: none;
        }

        .player-status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #4CAF50; /* Green */
            border-radius: 50%;
            margin-right: 8px;
        }

        .multiplayer-message {
            color: #FFD700;
            font-family: 'Inter', sans-serif;
            font-size: 0.9em;
            min-height: 1.5em;
            text-align: center;
            margin-top: 10px;
        }

        .multiplayer-room-info {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.1em;
        }

        /* --- NUEVOS ESTILOS PARA LA PANTALLA DE SELECCIÓN DE MODO DE JUEGO --- */
        .selection-container {
            /* Propiedades ya definidas en .multiplayer-container */
            gap: 30px; /* Espacio entre el header, grid de opciones y botón de volver */
        }

        .mode-options-grid {
            display: flex;
            flex-direction: row; /* Pone las tarjetas lado a lado */
            justify-content: center;
            align-items: flex-start; /* Alinea las tarjetas por arriba */
            gap: 40px; /* Espacio entre las tarjetas de modo */
            flex-wrap: wrap; /* Permite que se envuelvan en pantallas pequeñas */
        }

        .mode-option-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px; /* Espacio entre imagen y botón */
            background-color: #3a3a3a;
            border: 3px solid #8B4513;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 6px 6px 0px rgba(0, 0, 0, 0.5);
            min-width: 250px; /* Asegura un tamaño mínimo para la tarjeta */
            max-width: 300px; /* Asegura un tamaño máximo para la tarjeta */
            text-align: center;
        }

        .mode-image {
            width: 180px; /* Tamaño grande para las imágenes de modo */
            height: 180px;
            object-fit: contain;
            image-rendering: pixelated; /* Mantiene el estilo pixel art */
            border: 2px solid #5A2D0D;
            border-radius: 4px;
            background-color: #1a1a1a;
            padding: 5px;
        }

        .pixel-button.large-mode-button {
            width: 100%; /* El botón ocupa el ancho de la tarjeta */
            padding: 15px 25px;
            font-size: 1.1em; /* Fuente ligeramente más pequeña que el JUGAR principal */
        }

    </style>
</head>
<body>

    <div id="mainMenuContainer">
        <h1 class="game-title">THE SHIRUFFS ADVENTURE</h1>

        <div class="character-row-container">
            <!-- Se han quitado las imágenes de los personajes según lo solicitado -->
            <!-- <img src="" alt="Esqueleto Izquierda" class="character-icon skeleton-icon"> -->
            <!-- <img src="" alt="Personaje Central" class="character-icon main-character-icon"> -->
            <!-- <img src="" alt="Esqueleto Derecha" class="character-icon skeleton-icon"> -->
        </div>

        <div class="game-menu">
            <button id="playButton" class="pixel-button">
                JUGAR
            </button>
            <!-- El botón Multijugador ahora es un elemento directo del game-menu -->
            <button id="multiplayerButton" class="pixel-button">
                Multijugador
            </button>
            <!-- El grupo primary-buttons-group se ha eliminado de aquí -->
        </div>

        <button id="tiendaButton" aria-label="Tienda">
            TIENDA
        </button>

        <!-- Image of Icono de Tienda Pixel Art -->
        <img src="https://png.pngtree.com/png-vector/20220828/ourmid/pngtree-pixel-art-shop-icon-design-vector-png-image_6125107.png" onerror="this.onerror=null;this.src='https://placehold.co/150x150/000000/FFFFFF?text=TIENDA';" alt="Icono de Tienda Pixel Art" class="shop-icon">

        <!-- Nuevo botón de Logros, ahora como texto y reubicado -->
        <button id="logrosButton" aria-label="Logros">
            <img src="https://i.imgur.com/fr8O669.png" onerror="this.onerror=null;this.src='https://placehold.co/40x40/3f3f3f/FFFFFF?text=L';" alt="Logros Icono">
            LOGROS
        </button>

        <button id="usernameButton" aria-label="Usuario">
            USUARIO
        </button>

        <!-- Icono de Usuario Pixel Art Transparente (SVG inline) - Revertido a la versión original -->
        <svg class="user-icon-svg" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="6" y="2" width="4" height="4" fill="#eceff1"/>
            <rect x="4" y="7" width="8" height="5" fill="#eceff1"/>
        </svg>

        <!-- Nuevo botón "Próximamente..." -->
        <button id="upcomingButton" aria-label="Próximamente">
            <img src="https://i.imgur.com/73ede5.png" onerror="this.onerror=null;this.src='https://placehold.co/40x40/3f3f3f/FFFFFF?text=?'" alt="Próximamente Icono">
            PRÓXIMAMENTE...
        </button>

        <button id="musicToggleButton" aria-label="Toggle Music">
            MÚSICA ON
        </button>

        <audio id="background-music" loop autoplay>
            <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
            Tu navegador no soporta el elemento de audio.
        </audio>
    </div>

    <div id="shopContainer" class="hidden">
        <div class="shop-header">TIENDA</div>

        <div class="items-grid">
            <div class="item-card">
                <img src="https://i.imgur.com/Pz1YOyJ.png" onerror="this.onerror=null;this.src='https://placehold.co/60x60/3f3f3f/FFFFFF?text=Espada';" alt="Espada">
                <span class="item-name">Espada</span>
                <span class="item-price">100 G</span>
                <button class="buy-button" data-item="Espada">Comprar</button>
            </div>

            <div class="item-card">
                <img src="https://img.freepik.com/vector-premium/escudo-hierro-estilo-pixel-art_475147-439.jpg" onerror="this.onerror=null;this.src='https://placehold.co/60x60/3f3f3f/FFFFFF?text=Escudo';" alt="Escudo">
                <span class="item-name">Escudo</span>
                <span class="item-price">50 G</span>
                <button class="buy-button" data-item="Escudo de Madera">Comprar</button>
            </div>

            <div class="item-card">
                <img src="https://opengameart.org/sites/default/files/styles/medium/public/Potion.png" onerror="this.onerror=null;this.src='https://placehold.co/60x60/3f3f3f/FFFFFF?text=Poción';" alt="Poción de Vida">
                <span class="item-name">Poción de Vida</span>
                <span class="item-price">20 G</span>
                <button class="buy-button" data-item="Poción de Vida">Comprar</button>
            </div>

            <div class="item-card">
                <img src="https://opengameart.org/sites/default/files/axe.png" onerror="this.onerror=null;this.src='https://placehold.co/60x60/3f3f3f/FFFFFF?text=Hacha';" alt="Hacha de Batalla">
                <span class="item-name">Hacha de Batalla</span>
                <span class="item-price">120 G</span>
                <button class="buy-button" data-item="Hacha de Batalla">Comprar</button>
            </div>

            <!-- Nueva arma: Guadaña con la imagen proporcionada y tamaño ajustado -->
            <div class="item-card">
                <img src="https://i.imgur.com/jtOFzqU.png" class="scythe-icon" onerror="this.onerror=null;this.src='https://placehold.co/120x120/3f3f3f/FFFFFF?text=Guadaña';" alt="Guadaña">
                <span class="item-name">Guadaña</span>
                <span class="item-price">150 G</span>
                <button class="buy-button" data-item="Guadaña">Comprar</button>
            </div>
        </div>

        <button id="backToMenuButton" class="back-button">Volver al Menú</button>
    </div>

    <!-- Contenedor principal para todas las pantallas de autenticación -->
    <div id="authContainer" class="auth-container hidden">
        <p id="authMessage" class="auth-message"></p>
        <div id="authChoiceScreen" class="auth-screen-content hidden">
            <h2>BIENVENIDO</h2>
            <button id="showRegisterButton" class="auth-button">REGISTRARSE</button>
            <button id="showLoginButton" class="auth-button">INICIAR SESIÓN</button>
            <button id="backToMenuFromAuthChoices" class="back-button">VOLVER AL MENÚ</button>
        </div>
        <div id="registerScreen" class="auth-screen-content hidden">
            <h2>REGISTRARSE</h2>
            <input type="text" id="registerUsername" placeholder="Nombre de usuario (opcional)">
            <input type="email" id="registerEmail" placeholder="Correo electrónico" required>
            <input type="password" id="registerPassword" placeholder="Contraseña" required>
            <button id="submitRegisterButton" class="auth-button">REGISTRARSE</button>
            <button id="registerGoogleButton" class="auth-button google-button">INICIAR CON GOOGLE</button>
            <button id="backToAuthChoicesFromRegister" class="back-button">VOLVER</button>
        </div>
        <div id="loginScreen" class="auth-screen-content hidden">
            <h2>INICIAR SESIÓN</h2>
            <input type="email" id="loginEmail" placeholder="Correo electrónico" required>
            <input type="password" id="loginPassword" placeholder="Contraseña" required>
            <button id="submitLoginButton" class="auth-button">INICIAR SESIÓN</button>
            <button id="loginGoogleButtonForm" class="auth-button google-button">INICIAR CON GOOGLE</button>
            <button id="backToAuthChoicesFromLogin" class="back-button">VOLVER</button>
        </div>
    </div>

    <!-- Contenedor principal para el modo multijugador -->
    <div id="multiplayerContainer" class="multiplayer-container hidden">
        <h2 class="multiplayer-header">MODO MULTIJUGADOR</h2>
        <p id="multiplayerUserDisplay" class="text-green-400 mb-4"></p>
        <p id="multiplayerMessage" class="multiplayer-message"></p>

        <!-- Lobby del multijugador -->
        <div id="multiplayerLobby" class="multiplayer-section">
            <button id="createRoomButton" class="multiplayer-button">
                Crear Nueva Sala
            </button>

            <div class="mt-6 w-full flex flex-col items-center">
                <input
                    type="text"
                    id="roomCodeInput"
                    placeholder="Introduce el código de sala (6 dígitos)"
                    class="multiplayer-input"
                    maxlength="6"
                />
                <button id="joinRoomByCodeButton" class="multiplayer-button mt-3">
                    Unirse a Sala por Código
                </button>
            </div>
        </div>

        <!-- Vista de la sala (cuando el jugador está dentro de una sala) -->
        <div id="multiplayerRoomView" class="multiplayer-section hidden">
            <h3 class="multiplayer-room-info">Sala: <span id="currentRoomCodeDisplay"></span></h3>

            <div class="mb-6 text-center">
                <p class="text-xl font-bold mb-2">Estado del Juego:</p>
                <p class="text-lg">Águilas Rescatadas: <span id="aguilasRescatadasDisplay" class="text-yellow-300">0</span></p>
                <button id="rescueEagleButton" class="multiplayer-button mt-4 bg-purple-600 hover:bg-purple-700">
                    Rescatar Águila
                </button>
            </div>

            <div class="mb-6 w-full">
                <p class="text-xl font-bold mb-2">Jugadores en la Sala:</p>
                <ul id="playersList" class="player-list">
                    <!-- Los jugadores se insertarán aquí dinámicamente -->
                </ul>
            </div>

            <button id="leaveRoomButton" class="multiplayer-button red-button">
                Salir de Sala
            </button>
        </div>

        <button id="backToMainMenuFromMultiplayer" class="back-button mt-4">Volver al Menú</button>
    </div>

    <!-- Contenedor para la selección de modos de juego (Historia/Batalla) -->
    <div id="gameModeSelectionContainer" class="hidden selection-container">
        <h2 class="selection-header">Elige tu Aventura</h2>
        <div class="mode-options-grid">
            <div class="mode-option-card">
                <img src="https://i.imgur.com/Bb2QxyO.png" onerror="this.onerror=null;this.src='https://placehold.co/180x180/000000/FFFFFF?text=HISTORIA';" alt="Icono de Historia" class="mode-image">
                <button id="historiaButton" class="pixel-button large-mode-button">Historia</button>
            </div>
            <div class="mode-option-card">
                <!-- Imagen para Batalla actualizada -->
                <img src="https://i.imgur.com/sot15xN.png" onerror="this.onerror=null;this.src='https://placehold.co/180x180/000000/FFFFFF?text=BATALLA';" alt="Icono de Batalla" class="mode-image">
                <button id="batallaButton" class="pixel-button large-mode-button">Batalla</button>
            </div>
        </div>
        <button id="backToMainMenuFromGameModes" class="back-button">Volver al Menú</button>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, createUserWithEmailAndPassword, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut, updateProfile, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, collection, query, onSnapshot, deleteDoc, getDoc, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js"; // Importar Analytics

        // CONFIGURACIÓN DE FIREBASE ACTUALIZADA CON TUS VALORES REALES
        const firebaseConfig = {
            apiKey: "AIzaSyBVPNIsjeYqaGWiWngJRR-ZBGJ9JWI40yg",
            authDomain: "neonbeatsgame-c3c1d.firebaseapp.com",
            projectId: "neonbeatsgame-c3c1d",
            storageBucket: "neonbeatsgame-c3c1d.firebasestorage.app",
            messagingSenderId: "381267123393",
            appId: "1:381267123393:web:8058ce8b264a6ba91fc840",
            measurementId: "G-KVXTMB6NNN"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const analytics = getAnalytics(app); // Inicializar Analytics

        let currentUserId = null;
        let currentUserDisplayName = 'JugadorAnónimo';
        let currentRoomId = null;
        let unsubscribeRoomListener = null; // Para desuscribirse del listener de la sala actual

        // Referencias a los elementos DOM principales
        const mainMenuContainer = document.getElementById('mainMenuContainer');
        const shopContainer = document.getElementById('shopContainer');
        const authContainer = document.getElementById('authContainer');
        const multiplayerContainer = document.getElementById('multiplayerContainer'); // Nuevo contenedor multijugador
        const gameModeSelectionContainer = document.getElementById('gameModeSelectionContainer'); // Nuevo contenedor para selección de modo de juego

        const authChoiceScreen = document.getElementById('authChoiceScreen');
        const registerScreen = document.getElementById('registerScreen');
        const loginScreen = document.getElementById('loginScreen');
        const registerUsernameInput = document.getElementById('registerUsername');
        const registerEmailInput = document.getElementById('registerEmail');
        const registerPasswordInput = document.getElementById('registerPassword');
        const loginEmailInput = document.getElementById('loginEmail');
        const loginPasswordInput = document.getElementById('loginPassword');
        const authMessage = document.getElementById('authMessage');

        // Elementos del UI multijugador
        const multiplayerUserDisplay = document.getElementById('multiplayerUserDisplay');
        const multiplayerMessage = document.getElementById('multiplayerMessage');
        const multiplayerLobby = document.getElementById('multiplayerLobby');
        const multiplayerRoomView = document.getElementById('multiplayerRoomView');
        const roomCodeInput = document.getElementById('roomCodeInput');
        const currentRoomCodeDisplay = document.getElementById('currentRoomCodeDisplay');
        const aguilasRescatadasDisplay = document.getElementById('aguilasRescatadasDisplay');
        const playersList = document.getElementById('playersList');

        // Función para ocultar todas las pantallas
        function hideAllScreens() {
            mainMenuContainer.classList.add('hidden');
            shopContainer.classList.add('hidden');
            authContainer.classList.add('hidden');
            multiplayerContainer.classList.add('hidden');
            gameModeSelectionContainer.classList.add('hidden'); // Ocultar también la selección de modo de juego
            authChoiceScreen.classList.add('hidden');
            registerScreen.classList.add('hidden');
            loginScreen.classList.add('hidden');
            authMessage.textContent = '';
            multiplayerMessage.textContent = ''; // Limpiar mensaje multijugador
        }

        // Funciones para mostrar pantallas específicas
        function showMainMenu() {
            hideAllScreens();
            mainMenuContainer.classList.remove('hidden');
            // Asegurarse de desuscribirse de listeners de sala al volver al menú principal
            if (unsubscribeRoomListener) {
                unsubscribeRoomListener();
                unsubscribeRoomListener = null;
            }
        }

        function showShop() {
            hideAllScreens();
            shopContainer.classList.remove('hidden');
        }

        function showAuthChoiceScreen() {
            hideAllScreens();
            authContainer.classList.remove('hidden');
            authChoiceScreen.classList.remove('hidden');
        }

        function showRegisterScreen() {
            hideAllScreens();
            authContainer.classList.remove('hidden');
            registerScreen.classList.remove('hidden');
            registerUsernameInput.value = '';
            registerEmailInput.value = '';
            registerPasswordInput.value = '';
            authMessage.textContent = '';
        }

        function showLoginScreen() {
            hideAllScreens();
            authContainer.classList.remove('hidden');
            loginScreen.classList.remove('hidden');
            loginEmailInput.value = '';
            loginPasswordInput.value = '';
            authMessage.textContent = '';
        }

        // Función para mostrar la pantalla de multijugador
        async function showMultiplayer() {
            hideAllScreens();
            multiplayerContainer.classList.remove('hidden');
            multiplayerUserDisplay.textContent = `ID de Usuario: ${currentUserId}`;
            // Reiniciar la vista de multijugador
            multiplayerLobby.classList.remove('hidden');
            multiplayerRoomView.classList.add('hidden');
            roomCodeInput.value = '';
            multiplayerMessage.textContent = '';
        }

        // Función para mostrar la pantalla de selección de modo de juego (Historia/Batalla)
        function showGameModeSelection() {
            hideAllScreens();
            gameModeSelectionContainer.classList.remove('hidden');
        }

        // Listener para los cambios de estado de autenticación de Firebase
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                currentUserDisplayName = user.displayName || user.email?.split('@')[0] || 'JugadorAnónimo';
                console.log("Usuario autenticado:", user.email || "Anónimo", user.uid);

                document.getElementById('usernameButton').textContent = currentUserDisplayName.toUpperCase();
                document.getElementById('usernameButton').dataset.loggedIn = 'true';
                authMessage.textContent = `Bienvenido, ${currentUserDisplayName}.`;
                showMainMenu(); // Asegurarse de que el menú principal se muestre después de la autenticación
            } else {
                currentUserId = null;
                currentUserDisplayName = 'JugadorAnónimo';
                console.log("No hay usuario autenticado.");
                document.getElementById('usernameButton').textContent = 'USUARIO';
                document.getElementById('usernameButton').dataset.loggedIn = 'false';
                authMessage.textContent = '';

                // Intenta iniciar sesión anónimamente si no hay un usuario logeado
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                        console.log("Sesión iniciada con token personalizado.");
                    } catch (error) {
                        console.error("Error al iniciar sesión con token personalizado:", error);
                        try {
                            await signInAnonymously(auth);
                            console.log("Sesión iniciada anónimamente.");
                        } catch (anonError) {
                            console.error("Error al iniciar sesión anónimamente:", anonError);
                        }
                    }
                } else {
                    try {
                        await signInAnonymously(auth);
                        console.log("Sesión iniciada anónimamente (sin token inicial).");
                    } catch (anonError) {
                        console.error("Error al iniciar sesión anónimamente:", anonError);
                    }
                }
            }
        });

        // Funciones del modo multijugador
        const generateRoomCode = () => {
            let result = '';
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            const charactersLength = characters.length;
            for (let i = 0; i < 6; i++) {
                result += characters.charAt(Math.floor(Math.random() * charactersLength));
            }
            return result;
        };

        const createRoom = async () => {
            if (!db || !currentUserId) {
                multiplayerMessage.textContent = "Error: Usuario no autenticado.";
                return;
            }
            multiplayerMessage.textContent = 'Creando sala...';
            try {
                const newRoomCode = generateRoomCode();
                const newRoomRef = doc(collection(db, `artifacts/${appId}/public/data/gameRooms`));
                const roomId = newRoomRef.id;

                const newRoomData = {
                    roomCode: newRoomCode,
                    createdAt: new Date().toISOString(),
                    hostId: currentUserId,
                    players: [{ id: currentUserId, username: currentUserDisplayName }],
                    aguilasRescatadas: 0,
                    status: 'esperando'
                };

                await setDoc(newRoomRef, newRoomData);
                currentRoomId = roomId;
                multiplayerMessage.textContent = `Sala creada con código: ${newRoomCode}`;
                enterRoomView(newRoomData); // Actualiza la UI para mostrar la sala
            } catch (err) {
                console.error("Error creando sala:", err);
                multiplayerMessage.textContent = `Error creando sala: ${err.message}`;
            }
        };

        const joinRoomByCode = async () => {
            if (!db || !currentUserId) {
                multiplayerMessage.textContent = "Error: Usuario no autenticado.";
                return;
            }
            const code = roomCodeInput.value.toUpperCase();
            if (!code || code.length !== 6) {
                multiplayerMessage.textContent = "Por favor, introduce un código de sala válido de 6 dígitos.";
                return;
            }
            multiplayerMessage.textContent = 'Uniéndose a sala...';
            try {
                const roomsCollectionRef = collection(db, `artifacts/${appId}/public/data/gameRooms`);
                const q = query(roomsCollectionRef, where('roomCode', '==', code));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const roomDoc = querySnapshot.docs[0];
                    const roomId = roomDoc.id;
                    const roomData = roomDoc.data();
                    let players = roomData.players || [];

                    const isPlayerAlreadyInRoom = players.some(player => player.id === currentUserId);

                    if (!isPlayerAlreadyInRoom) {
                        players = [...players, { id: currentUserId, username: currentUserDisplayName }];
                        await updateDoc(doc(db, `artifacts/${appId}/public/data/gameRooms`, roomId), { players: players });
                    }
                    currentRoomId = roomId;
                    multiplayerMessage.textContent = `Unido a sala: ${code}`;
                    enterRoomView(roomData); // Actualiza la UI para mostrar la sala
                } else {
                    multiplayerMessage.textContent = "La sala no existe o el código es incorrecto.";
                }
            } catch (err) {
                console.error("Error al unirse a sala:", err);
                multiplayerMessage.textContent = `Error al unirse a sala: ${err.message}`;
            }
        };

        const leaveRoom = async () => {
            if (!db || !currentUserId || !currentRoomId) return;
            multiplayerMessage.textContent = 'Saliendo de la sala...';
            try {
                const roomRef = doc(db, `artifacts/${appId}/public/data/gameRooms`, currentRoomId);
                const roomSnap = await getDoc(roomRef);

                if (roomSnap.exists()) {
                    let players = roomSnap.data().players || [];
                    const updatedPlayers = players.filter(player => player.id !== currentUserId);

                    if (updatedPlayers.length === 0) {
                        await deleteDoc(roomRef);
                        console.log("Sala eliminada porque está vacía.");
                    } else {
                        await updateDoc(roomRef, { players: updatedPlayers });
                        console.log("Jugador ha abandonado la sala.");
                    }
                }
                currentRoomId = null;
                roomCodeInput.value = '';
                multiplayerMessage.textContent = "Has salido de la sala.";
                // Desuscribirse del listener de la sala al salir
                if (unsubscribeRoomListener) {
                    unsubscribeRoomListener();
                    unsubscribeRoomListener = null;
                }
                // Volver al lobby del multijugador
                multiplayerLobby.classList.remove('hidden');
                multiplayerRoomView.classList.add('hidden');
            } catch (err) {
                console.error("Error al salir de la sala:", err);
                multiplayerMessage.textContent = `Error al salir de la sala: ${err.message}`;
            }
        };

        const rescueEagle = async () => {
            if (!db || !currentRoomId) {
                multiplayerMessage.textContent = "No estás en una sala activa.";
                return;
            }
            multiplayerMessage.textContent = 'Rescatando águila...';
            try {
                const roomRef = doc(db, `artifacts/${appId}/public/data/gameRooms`, currentRoomId);
                const roomSnap = await getDoc(roomRef);
                if (roomSnap.exists()) {
                    const currentAguilas = roomSnap.data().aguilasRescatadas || 0;
                    await updateDoc(roomRef, { aguilasRescatadas: currentAguilas + 1 });
                    multiplayerMessage.textContent = "¡Águila rescatada!";
                }
            } catch (err) {
                console.error("Error al rescatar águila:", err);
                multiplayerMessage.textContent = `Error al rescatar águila: ${err.message}`;
            }
        };


        // Función para entrar a la vista de la sala y suscribirse a updates
        function enterRoomView(roomData) {
            multiplayerLobby.classList.add('hidden');
            multiplayerRoomView.classList.remove('hidden');

            // Actualizar la UI de la sala con los datos iniciales
            currentRoomCodeDisplay.textContent = roomData.roomCode;
            aguilasRescatadasDisplay.textContent = roomData.aguilasRescatadas;
            updatePlayersList(roomData.players, roomData.hostId); // Pasa hostId aquí

            // Suscribirse a actualizaciones en tiempo real de esta sala
            const roomDocRef = doc(db, `artifacts/${appId}/public/data/gameRooms`, currentRoomId);
            unsubscribeRoomListener = onSnapshot(roomDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const latestRoomData = docSnap.data();
                    aguilasRescatadasDisplay.textContent = latestRoomData.aguilasRescatadas;
                    updatePlayersList(latestRoomData.players, latestRoomData.hostId); // Pasa hostId aquí
                } else {
                    // La sala ya no existe, el jugador es forzado a salir
                    currentRoomId = null;
                    multiplayerMessage.textContent = "La sala ha sido eliminada por el anfitrión o ha expirado.";
                    showMultiplayer(); // Volver a la pantalla de lobby multijugador
                }
            }, (error) => {
                console.error("Error en el listener de la sala:", error);
                multiplayerMessage.textContent = `Error en la sala: ${error.message}`;
            });
        }

        // Función para actualizar la lista de jugadores en la UI
        function updatePlayersList(players, hostId) { // Recibe hostId como argumento
            playersList.innerHTML = ''; // Limpiar la lista actual
            if (players && players.length > 0) {
                players.forEach(player => {
                    const li = document.createElement('li');
                    li.classList.add('player-item');
                    const dot = document.createElement('span');
                    dot.classList.add('player-status-dot');
                    li.appendChild(dot);
                    
                    let hostText = '';
                    if (player.id === hostId) { // Usa directamente el hostId pasado
                        hostText = '(Anfitrión)';
                    }
                    li.innerHTML += `${player.username} ${player.id === currentUserId ? '(Tú)' : ''} ${hostText}`;
                    playersList.appendChild(li);
                });
            } else {
                const li = document.createElement('li');
                li.classList.add('player-item');
                li.textContent = 'Esperando jugadores...';
                playersList.appendChild(li);
            }
        }


        // Event Listeners
        document.getElementById('playButton').addEventListener('click', function() {
            console.log('¡Botón "JUGAR" clickeado!');
            showGameModeSelection(); // Muestra la nueva pantalla de selección de modo de juego
        });

        // Estos listeners se movieron a la nueva pantalla de selección de modo
        document.getElementById('gameModeSelectionContainer').querySelector('#historiaButton').addEventListener('click', function() {
            console.log('¡Botón "Historia" clickeado!');
            // Aquí puedes añadir la lógica para iniciar el modo historia
            multiplayerMessage.textContent = "Modo Historia en construcción...";
            setTimeout(() => multiplayerMessage.textContent = '', 2000);
        });

        document.getElementById('gameModeSelectionContainer').querySelector('#batallaButton').addEventListener('click', function() {
            console.log('¡Botón "Batalla" clickeado!');
            // Aquí puedes añadir la lógica para iniciar el modo batalla
            multiplayerMessage.textContent = "Modo Batalla en construcción...";
            setTimeout(() => multiplayerMessage.textContent = '', 2000);
        });

        document.getElementById('multiplayerButton').addEventListener('click', function() {
            console.log('¡Botón "Multijugador" clickeado!');
            showMultiplayer();
        });

        document.getElementById('tiendaButton').addEventListener('click', function() {
            console.log('¡Botón "TIENDA" clickeado!');
            showShop();
        });

        document.getElementById('backToMenuButton').addEventListener('click', function() {
            console.log('Volver al Menú clickeado desde la tienda');
            showMainMenu();
        });

        document.getElementById('usernameButton').addEventListener('click', function() {
            if (this.dataset.loggedIn === 'true') {
                const wantsToSignOut = confirm('¿Quieres cerrar sesión?'); // Usar confirm por ahora
                if (wantsToSignOut) {
                    signOut(auth).then(() => {
                        console.log('Sesión cerrada.');
                        authMessage.textContent = "Sesión cerrada.";
                        setTimeout(() => authMessage.textContent = '', 2000);
                        showMainMenu();
                    }).catch(error => {
                        console.error("Error al cerrar sesión:", error);
                        authMessage.textContent = `Error al cerrar sesión: ${error.message}`;
                    });
                }
            } else {
                showAuthChoiceScreen();
            }
        });

        document.getElementById('logrosButton').addEventListener('click', function() {
            console.log('¡Botón "LOGROS" clickeado!');
            multiplayerMessage.textContent = "Funcionalidad de Logros en construcción..."; // Temporalmente muestra mensaje aquí
            setTimeout(() => multiplayerMessage.textContent = '', 2000);
        });

        // Nuevo event listener para el botón "Próximamente..."
        document.getElementById('upcomingButton').addEventListener('click', function() {
            console.log('¡Botón "Próximamente..." clickeado!');
            multiplayerMessage.textContent = "¡Esta característica estará disponible pronto!";
            setTimeout(() => multiplayerMessage.textContent = '', 2000);
        });

        document.getElementById('showRegisterButton').addEventListener('click', showRegisterScreen);
        document.getElementById('showLoginButton').addEventListener('click', showLoginScreen);
        document.getElementById('backToMenuFromAuthChoices').addEventListener('click', showMainMenu);
        document.getElementById('backToMainMenuFromMultiplayer').addEventListener('click', showMainMenu); // Nuevo botón de volver en multijugador
        document.getElementById('backToMainMenuFromGameModes').addEventListener('click', showMainMenu); // Nuevo botón de volver desde selección de modo de juego

        document.getElementById('backToAuthChoicesFromRegister').addEventListener('click', showAuthChoiceScreen);
        document.getElementById('submitRegisterButton').addEventListener('click', async () => {
            const username = registerUsernameInput.value;
            const email = registerEmailInput.value;
            const password = registerPasswordInput.value;
            authMessage.textContent = 'Registrando...';
            console.log(`Intentando registrar: Usuario=${username}, Email=${email}`);

            if (!email || !password) {
                authMessage.textContent = 'Por favor, introduce un correo y contraseña.';
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                if (username) {
                    await updateProfile(user, { displayName: username });
                    console.log("Perfil de usuario actualizado con nombre:", username);
                }

                console.log("Usuario registrado con éxito:", user.email, "Nombre de visualización:", user.displayName || 'N/A');
                authMessage.textContent = `Registro exitoso para ${user.displayName || user.email}. ¡Bienvenido!`;

                const userRef = doc(db, `artifacts/${appId}/users/${user.uid}/profile`, 'data');
                await setDoc(userRef, {
                    email: user.email,
                    displayName: user.displayName || '',
                    username: username || '',
                    createdAt: new Date()
                }, { merge: true });
                console.log("Documento de usuario creado/actualizado en Firestore.");

                setTimeout(showMainMenu, 2000);
            } catch (error) {
                console.error("Error al registrar:", error);
                authMessage.textContent = `Error al registrar: ${error.message}`;
            }
        });

        document.getElementById('backToAuthChoicesFromLogin').addEventListener('click', showAuthChoiceScreen);
        document.getElementById('submitLoginButton').addEventListener('click', async () => {
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
            authMessage.textContent = 'Iniciando sesión...';
            console.log(`Intentando iniciar sesión: Email=${email}`);

            if (!email || !password) {
                authMessage.textContent = 'Por favor, introduce un correo y contraseña.';
                return;
            }

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                console.log("Usuario logeado con éxito:", userCredential.user.email);
                authMessage.textContent = `Inicio de sesión exitoso para ${userCredential.user.displayName || userCredential.user.email}. ¡Bienvenido!`;
                setTimeout(showMainMenu, 2000);
            } catch (error) {
                console.error("Error al iniciar sesión:", error);
                authMessage.textContent = `Error al iniciar sesión: ${error.message}`;
            }
        });

        document.getElementById('registerGoogleButton').addEventListener('click', async () => {
            authMessage.textContent = 'Iniciando sesión con Google...';
            console.log('Intentando iniciar sesión con Google desde registro.');
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                console.log("Usuario logeado con Google con éxito:", user.displayName || user.email);
                authMessage.textContent = `Inicio de sesión exitoso con Google para ${user.displayName || user.email}. ¡Bienvenido!`;
                const userRef = doc(db, `artifacts/${appId}/users/${user.uid}/profile`, 'data');
                await setDoc(userRef, {
                    email: user.email,
                    displayName: user.displayName || '',
                    createdAt: new Date()
                }, { merge: true });
                console.log("Documento de usuario (Google) creado/actualizado en Firestore.");
                setTimeout(showMainMenu, 2000);
            } catch (error) {
                console.error("Error al iniciar sesión con Google:", error);
                authMessage.textContent = `Error al iniciar sesión con Google: ${error.message}`;
            }
        });

        document.getElementById('loginGoogleButtonForm').addEventListener('click', async () => {
            authMessage.textContent = 'Iniciando sesión con Google...';
            console.log('Intentando iniciar sesión con Google desde login.');
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                console.log("Usuario logeado con Google con éxito:", user.displayName || user.email);
                authMessage.textContent = `Inicio de sesión exitoso con Google para ${user.displayName || user.email}. ¡Bienvenido!`;
                const userRef = doc(db, `artifacts/${appId}/users/${user.uid}/profile`, 'data');
                await setDoc(userRef, {
                    email: user.email,
                    displayName: user.displayName || '',
                    createdAt: new Date()
                }, { merge: true });
                console.log("Documento de usuario (Google) creado/actualizado en Firestore.");
                setTimeout(showMainMenu, 2000);
            } catch (error) {
                console.error("Error al iniciar sesión con Google:", error);
                authMessage.textContent = `Error al iniciar sesión con Google: ${error.message}`;
            }
        });

        // Event Listeners para el modo multijugador
        document.getElementById('createRoomButton').addEventListener('click', createRoom);
        document.getElementById('joinRoomByCodeButton').addEventListener('click', joinRoomByCode);
        document.getElementById('leaveRoomButton').addEventListener('click', leaveRoom);
        document.getElementById('rescueEagleButton').addEventListener('click', rescueEagle);

        const backgroundMusic = document.getElementById('background-music');
        const musicToggleButton = document.getElementById('musicToggleButton');

        backgroundMusic.play().catch(() => {
            console.log("Autoplay bloqueado, esperando interacción del usuario para reproducir música.");
            musicToggleButton.textContent = "MÚSICA OFF";
            const musicMessage = document.createElement('div');
            musicMessage.id = 'musicAutoPlayMessage';
            musicMessage.textContent = 'Haz clic en el botón MÚSICA para activar el sonido.';
            document.body.appendChild(musicMessage);
        });

        musicToggleButton.addEventListener('click', function() {
            if (backgroundMusic.paused) {
                backgroundMusic.play()
                    .then(() => {
                        musicToggleButton.textContent = "MÚSICA ON";
                        const musicMessage = document.getElementById('musicAutoPlayMessage');
                        if (musicMessage) {
                            musicMessage.remove();
                        }
                    })
                    .catch(e => console.log("Error al reproducir música:", e));
            } else {
                backgroundMusic.pause();
                musicToggleButton.textContent = "MÚSICA OFF";
            }
        });

        function resumeAudioOnFirstInteraction() {
            if (backgroundMusic.paused) {
                backgroundMusic.play()
                    .then(() => {
                        console.log("Música reanudada por interacción del usuario.");
                        musicToggleButton.textContent = "MÚSICA ON";
                        document.body.removeEventListener('click', resumeAudioOnFirstInteraction);
                        const musicMessage = document.getElementById('musicAutoPlayMessage');
                        if (musicMessage) {
                            musicMessage.remove();
                        }
                    })
                    .catch(e => console.log("Error al reanudar música al hacer clic:", e));
            } else {
                document.body.removeEventListener('click', resumeAudioOnFirstInteraction);
            }
        }

        document.body.addEventListener('click', resumeAudioOnFirstInteraction);

        showMainMenu(); // Asegura que el menú principal se muestre al cargar
    </script>

</body>
</html>
